<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />
<link rel="icon" href="<cms:cache_buster 'favicon.ico' />" />
<cms:php>
    function minify_css($str) {
        # remove comments first (simplifies the other regex)
        $re1 = <<< 'EOS'
            (?sx)
              # quotes
              (
                "(?:[^"\\]++|\\.)*+"
              | '(?:[^'\\]++|\\.)*+'
              )
            |
              # comments
              /\* (?> .*? \*/ )
EOS;

        $re2 = <<< 'EOS'
            (?six)
              # quotes
              (
                "(?:[^"\\]++|\\.)*+"
              | '(?:[^'\\]++|\\.)*+'
              )
            |
              # ; before } (and the spaces after it while we're here)
              \s*+ ; \s*+ ( } ) \s*+
            |
              # all spaces around meta chars/operators
              \s*+ ( [*$~^|]?+= | [{};,>~+-] | !important\b ) \s*+
            |
              # spaces right of ( [ :
              ( [[(:] ) \s++
            |
              # spaces left of ) ]
              \s++ ( [])] )
            |
              # spaces left (and right) of :
              \s++ ( : ) \s*+
              # but not in selectors: not followed by a {
              (?!
                (?>
                  [^{}"']++
                | "(?:[^"\\]++|\\.)*+"
                | '(?:[^'\\]++|\\.)*+' 
                )*+
                {
              )
            |
              # spaces at beginning/end of string
              ^ \s++ | \s++ \z
            |
              # double spaces to single
              (\s)\s+
EOS;

        $str = preg_replace("%$re1%", '$1', $str);
        return preg_replace("%$re2%", '$1$2$3$4$5$6$7', $str);
    }
    
    $time = filemtime('<cms:show k_site_path />css/generated.css');
    $it = new FilesystemIterator('<cms:show k_site_path />css');
    
    foreach ($it as $file) {
        if($file->getExtension() == 'css') {
            if($file->getFilename() == 'generated.css') {
                continue;
            }
            if($file->getMTime() > $time) {
                $css = file_get_contents("<cms:show k_site_link />css/generate_css.php");
                $css = substr($css, 0, strpos($css, "<!--"));
                $css = minify_css($css);
                file_put_contents('<cms:show k_site_path />css/generated.css', $css);
                break;
            }
        }
    }
</cms:php>
